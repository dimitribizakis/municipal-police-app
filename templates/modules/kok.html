{% extends "base_v2.html" %}

{% block title %}ΚΟΚ - Κώδικας Οδικής Κυκλοφορίας{% endblock %}

{% block content %}
<!-- Navigation Header -->
<div class="row mb-3">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Κεντρικό Dashboard</a></li>
                <li class="breadcrumb-item active">ΚΟΚ</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary me-2">
                    <i class="fas fa-arrow-left me-1"></i>Επιστροφή
                </a>
                <div>
                    <h2 class="mb-0 text-danger">
                        <i class="fas fa-car me-2"></i>ΚΟΚ - Κώδικας Οδικής Κυκλοφορίας
                    </h2>
                    <small class="text-muted">Καταχώρηση παραβάσεων και έκδοση εντολών</small>
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('kok_view_violations') }}" class="btn btn-info">
                    <i class="fas fa-list me-1"></i>Προβολή Παραβάσεων
                </a>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                    <i class="fas fa-sign-out-alt me-1"></i>Αποσύνδεση
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="row mb-3">
            <div class="col-12">
                {% for category, message in messages %}
                    <div class="alert alert-{% if category == 'error' %}danger{% elif category == 'success' %}success{% elif category == 'warning' %}warning{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
{% endwith %}

<!-- Main Form -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>Καταχώρηση Νέας Παράβασης ΚΟΚ
                </h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('kok_submit_violation') }}" method="POST" enctype="multipart/form-data" id="violationForm">
                    <!-- Στοιχεία Οχήματος -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-car me-2"></i>Στοιχεία Οχήματος
                            </h6>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="license_plate" class="form-label">Αριθμός Κυκλοφορίας *</label>
                            <input type="text" class="form-control" id="license_plate" name="license_plate" required 
                                   placeholder="π.χ. ΑΒΓ-1234" style="text-transform: uppercase;">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="vehicle_brand" class="form-label">Μάρκα Οχήματος *</label>
                            <input type="text" class="form-control" id="vehicle_brand" name="vehicle_brand" required 
                                   placeholder="π.χ. TOYOTA, MERCEDES">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="vehicle_color" class="form-label">Χρώμα Οχήματος *</label>
                            <select class="form-select" id="vehicle_color" name="vehicle_color" required>
                                <option value="">Επιλέξτε χρώμα...</option>
                                {% for color in vehicle_colors %}
                                <option value="{{ color.value }}">{{ color.value }}</option>
                                {% endfor %}
                                <option value="custom">Άλλο χρώμα...</option>
                            </select>
                            <input type="text" class="form-control mt-2" id="custom_vehicle_color" name="custom_vehicle_color" 
                                   placeholder="Πληκτρολογήστε χρώμα..." style="display: none;">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="vehicle_type" class="form-label">Τύπος Οχήματος *</label>
                            <select class="form-select" id="vehicle_type" name="vehicle_type" required>
                                <option value="">Επιλέξτε τύπο...</option>
                                {% for type in vehicle_types %}
                                <option value="{{ type.value }}">{{ type.value }}</option>
                                {% endfor %}
                                <option value="custom">Άλλος τύπος...</option>
                            </select>
                            <input type="text" class="form-control mt-2" id="custom_vehicle_type" name="custom_vehicle_type" 
                                   placeholder="Πληκτρολογήστε τύπο..." style="display: none;">
                        </div>
                    </div>
                    
                    <!-- Στοιχεία Παράβασης -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-map-marker-alt me-2"></i>Στοιχεία Παράβασης
                            </h6>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="violation_date" class="form-label">Ημερομηνία Παράβασης *</label>
                            <input type="date" class="form-control" id="violation_date" name="violation_date" 
                                   value="{{ datetime.now().strftime('%Y-%m-%d') }}" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="violation_time" class="form-label">Ώρα Παράβασης *</label>
                            <input type="time" class="form-control" id="violation_time" name="violation_time" 
                                   value="{{ datetime.now().strftime('%H:%M') }}" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="street" class="form-label">Οδός *</label>
                            <input type="text" class="form-control" id="street" name="street" required 
                                   placeholder="π.χ. Πανεπιστημίου">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="street_number" class="form-label">Αριθμός *</label>
                            <input type="text" class="form-control" id="street_number" name="street_number" required 
                                   placeholder="π.χ. 123">
                        </div>
                    </div>
                    
                    <!-- Επιλογή Παραβάσεων -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>Παραβάσεις ΚΟΚ
                            </h6>
                            <div class="row">
                                {% for violation in violations %}
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               id="violation_{{ loop.index0 }}" 
                                               name="violations" 
                                               value="{{ loop.index0 }}">
                                        <label class="form-check-label" for="violation_{{ loop.index0 }}">
                                            <strong>{{ violation.article }}</strong> - {{ violation.description }}
                                            {% if violation.fine_cars or violation.fine_motorcycles %}
                                            <br><small class="text-success">
                                                Πρόστιμο: 
                                                {% if violation.fine_cars %}{{ violation.fine_cars }}€ (αυτοκίνητα){% endif %}
                                                {% if violation.fine_motorcycles %} {{ violation.fine_motorcycles }}€ (μοτοσικλέτες){% endif %}
                                            </small>
                                            {% endif %}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Επιτόπια Μέτρα -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-tools me-2"></i>Επιτόπια Μέτρα
                            </h6>
                            <div class="row">
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="plates_removed" name="plates_removed">
                                        <label class="form-check-label" for="plates_removed">
                                            Αφαίρεση Πινακίδων
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="license_removed" name="license_removed">
                                        <label class="form-check-label" for="license_removed">
                                            Αφαίρεση Άδειας Οδήγησης
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="registration_removed" name="registration_removed">
                                        <label class="form-check-label" for="registration_removed">
                                            Αφαίρεση Άδειας Κυκλοφορίας
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Φωτογραφία -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-camera me-2"></i>Φωτογραφία
                            </h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="photo_file" class="form-label">Ανέβασμα Φωτογραφίας</label>
                                    <input type="file" class="form-control" id="photo_file" name="photo_file" accept="image/*">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Λήψη Φωτογραφίας</label>
                                    <br>
                                    <button type="button" class="btn btn-info" onclick="startCamera()">
                                        <i class="fas fa-camera me-1"></i>Άνοιγμα Κάμερας
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Camera Section -->
                            <div id="cameraSection" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <video id="video" width="320" height="240" autoplay></video>
                                        <br>
                                        <button type="button" class="btn btn-success mt-2" onclick="takePhoto()">
                                            <i class="fas fa-camera me-1"></i>Λήψη Φωτογραφίας
                                        </button>
                                        <button type="button" class="btn btn-secondary mt-2" onclick="stopCamera()">
                                            <i class="fas fa-times me-1"></i>Κλείσιμο
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <canvas id="canvas" width="320" height="240" style="display: none;"></canvas>
                                        <img id="photo" style="display: none; max-width: 320px; max-height: 240px;">
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="photo_data" name="photo_data">
                        </div>
                    </div>
                    
                    <!-- Στοιχεία Οδηγού -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-user me-2"></i>Στοιχεία Οδηγού
                            </h6>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="driver_present" name="driver_present">
                                <label class="form-check-label" for="driver_present">
                                    <strong>Ο οδηγός είναι παρών</strong>
                                </label>
                            </div>
                            
                            <div id="driverFields" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="driver_last_name" class="form-label">Επώνυμο *</label>
                                        <input type="text" class="form-control" id="driver_last_name" name="driver_last_name">
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="driver_first_name" class="form-label">Όνομα *</label>
                                        <input type="text" class="form-control" id="driver_first_name" name="driver_first_name">
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="driver_father_name" class="form-label">Πατρώνυμο *</label>
                                        <input type="text" class="form-control" id="driver_father_name" name="driver_father_name">
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="driver_afm" class="form-label">ΑΦΜ *</label>
                                        <input type="text" class="form-control" id="driver_afm" name="driver_afm" 
                                               pattern="[0-9]{9}" placeholder="123456789">
                                    </div>
                                    
                                    <div class="col-12 mb-3">
                                        <label class="form-label">Υπογραφή Οδηγού</label>
                                        <div class="border" style="width: 400px; height: 200px;">
                                            <canvas id="signatureCanvas" width="400" height="200" style="cursor: crosshair;"></canvas>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="clearSignature()">
                                            <i class="fas fa-eraser me-1"></i>Καθαρισμός
                                        </button>
                                        <input type="hidden" id="signature_data" name="signature_data">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="row">
                        <div class="col-12 text-center">
                            <button type="submit" class="btn btn-danger btn-lg px-5">
                                <i class="fas fa-save me-2"></i>Καταχώρηση Παράβασης
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Custom color/type handlers
document.getElementById('vehicle_color').addEventListener('change', function() {
    const customInput = document.getElementById('custom_vehicle_color');
    if (this.value === 'custom') {
        customInput.style.display = 'block';
        customInput.required = true;
    } else {
        customInput.style.display = 'none';
        customInput.required = false;
        customInput.value = '';
    }
});

document.getElementById('vehicle_type').addEventListener('change', function() {
    const customInput = document.getElementById('custom_vehicle_type');
    if (this.value === 'custom') {
        customInput.style.display = 'block';
        customInput.required = true;
    } else {
        customInput.style.display = 'none';
        customInput.required = false;
        customInput.value = '';
    }
});

// Driver present handler
document.getElementById('driver_present').addEventListener('change', function() {
    const driverFields = document.getElementById('driverFields');
    const requiredFields = driverFields.querySelectorAll('input[type="text"]');
    
    if (this.checked) {
        driverFields.style.display = 'block';
        requiredFields.forEach(field => field.required = true);
    } else {
        driverFields.style.display = 'none';
        requiredFields.forEach(field => {
            field.required = false;
            field.value = '';
        });
        clearSignature();
    }
});

// Camera functionality
let video, canvas, photo;

function startCamera() {
    document.getElementById('cameraSection').style.display = 'block';
    video = document.getElementById('video');
    canvas = document.getElementById('canvas');
    photo = document.getElementById('photo');
    
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;
        })
        .catch(err => {
            console.error('Error accessing camera:', err);
            alert('Σφάλμα πρόσβασης στην κάμερα');
        });
}

function takePhoto() {
    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, 320, 240);
    
    const dataURL = canvas.toDataURL('image/jpeg');
    document.getElementById('photo_data').value = dataURL;
    
    photo.src = dataURL;
    photo.style.display = 'block';
    
    alert('Φωτογραφία ελήφθη επιτυχώς!');
}

function stopCamera() {
    if (video && video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
    }
    document.getElementById('cameraSection').style.display = 'none';
}

// Signature functionality
let isDrawing = false;
let signatureCanvas, signatureContext;

document.addEventListener('DOMContentLoaded', function() {
    signatureCanvas = document.getElementById('signatureCanvas');
    signatureContext = signatureCanvas.getContext('2d');
    
    signatureCanvas.addEventListener('mousedown', startDrawing);
    signatureCanvas.addEventListener('mousemove', draw);
    signatureCanvas.addEventListener('mouseup', stopDrawing);
    signatureCanvas.addEventListener('mouseout', stopDrawing);
    
    // Touch events for mobile
    signatureCanvas.addEventListener('touchstart', handleTouch);
    signatureCanvas.addEventListener('touchmove', handleTouch);
    signatureCanvas.addEventListener('touchend', stopDrawing);
});

function startDrawing(e) {
    isDrawing = true;
    draw(e);
}

function draw(e) {
    if (!isDrawing) return;
    
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    signatureContext.lineWidth = 2;
    signatureContext.lineCap = 'round';
    signatureContext.strokeStyle = '#000';
    
    signatureContext.lineTo(x, y);
    signatureContext.stroke();
    signatureContext.beginPath();
    signatureContext.moveTo(x, y);
}

function stopDrawing() {
    if (isDrawing) {
        isDrawing = false;
        signatureContext.beginPath();
        
        // Save signature data
        const signatureData = signatureCanvas.toDataURL();
        document.getElementById('signature_data').value = signatureData;
    }
}

function handleTouch(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                     e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
        clientX: touch.clientX,
        clientY: touch.clientY
    });
    signatureCanvas.dispatchEvent(mouseEvent);
}

function clearSignature() {
    signatureContext.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    document.getElementById('signature_data').value = '';
}

// License plate uppercase
document.getElementById('license_plate').addEventListener('input', function() {
    this.value = this.value.toUpperCase();
});
</script>

{% endblock %}