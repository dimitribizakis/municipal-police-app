{% extends "base_v2.html" %}

{% block title %}Επεξεργασία Παράβασης #{{ violation.id }} - Admin{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2 class="text-primary">
            <i class="fas fa-edit me-2"></i>Επεξεργασία Παράβασης #{{ violation.id }}
        </h2>
        <p class="text-muted">
            Καταχωρήθηκε από: {{ violation.officer.full_name }} | 
            {{ violation.created_at.strftime('%d/%m/%Y %H:%M') }}
        </p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{{ url_for('admin_violations') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Επιστροφή
        </a>
        <a href="{{ url_for('view_violation', violation_id=violation.id) }}" class="btn btn-outline-info">
            <i class="fas fa-eye me-1"></i>Προβολή
        </a>
    </div>
</div>

<form method="POST" action="{{ url_for('admin_edit_violation', violation_id=violation.id) }}">
    <div class="row">
        <div class="col-12">
            
            <!-- Στοιχεία Οχήματος -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-car me-2"></i>Στοιχεία Οχήματος
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="license_plate" class="form-label">
                                <i class="fas fa-tag me-1"></i>Αριθμός Κυκλοφορίας *
                            </label>
                            <input type="text" class="form-control" id="license_plate" name="license_plate" 
                                   value="{{ violation.license_plate }}" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="vehicle_brand" class="form-label">
                                <i class="fas fa-industry me-1"></i>Μάρκα Οχήματος *
                            </label>
                            <input type="text" class="form-control" id="vehicle_brand" name="vehicle_brand" 
                                   value="{{ violation.vehicle_brand }}" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="vehicle_color" class="form-label">
                                <i class="fas fa-palette me-1"></i>Χρώμα Οχήματος *
                            </label>
                            <div class="input-group">
                                <select class="form-select" id="vehicle_color" name="vehicle_color" required>
                                    <option value="{{ violation.vehicle_color }}" selected>{{ violation.vehicle_color }}</option>
                                    {% for color in vehicle_colors %}
                                        {% if color.value != violation.vehicle_color %}
                                        <option value="{{ color.value }}">{{ color.value }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-secondary" onclick="editColor()">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="vehicle_type" class="form-label">
                                <i class="fas fa-car-side me-1"></i>Τύπος Οχήματος *
                            </label>
                            <div class="input-group">
                                <select class="form-select" id="vehicle_type" name="vehicle_type" required>
                                    <option value="{{ violation.vehicle_type }}" selected>{{ violation.vehicle_type }}</option>
                                    {% for type in vehicle_types %}
                                        {% if type.value != violation.vehicle_type %}
                                        <option value="{{ type.value }}">{{ type.value }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-secondary" onclick="editType()">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Στοιχεία Παράβασης -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Στοιχεία Παράβασης
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="violation_date" class="form-label">
                                <i class="fas fa-calendar me-1"></i>Ημερομηνία Παράβασης *
                            </label>
                            <input type="date" class="form-control" id="violation_date" name="violation_date" 
                                   value="{{ violation.violation_date.strftime('%Y-%m-%d') }}" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="violation_time" class="form-label">
                                <i class="fas fa-clock me-1"></i>Ώρα Παράβασης *
                            </label>
                            <input type="time" class="form-control" id="violation_time" name="violation_time" 
                                   value="{{ violation.violation_time.strftime('%H:%M') }}" required>
                        </div>
                        
                        <div class="col-md-8 mb-3">
                            <label for="street" class="form-label">
                                <i class="fas fa-road me-1"></i>Οδός *
                            </label>
                            <input type="text" class="form-control" id="street" name="street" 
                                   value="{{ violation.street }}" required>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="street_number" class="form-label">
                                <i class="fas fa-hashtag me-1"></i>Αριθμός *
                            </label>
                            <input type="text" class="form-control" id="street_number" name="street_number" 
                                   value="{{ violation.street_number }}" required>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label class="form-label">
                                <i class="fas fa-list me-1"></i>Παραβάσεις *
                            </label>
                            <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                {% set selected_violations = violation.get_selected_violations_list() %}
                                {% for viol in violations_list %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="violations" 
                                           value="{{ viol.code }}" id="violation_{{ loop.index }}"
                                           {% if viol.code in selected_violations %}checked{% endif %}>
                                    <label class="form-check-label" for="violation_{{ loop.index }}">
                                        <strong>{{ viol.code }}</strong> - {{ viol.description }}
                                        <span class="text-muted">({{ viol.fine }}€)</span>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Επιτόπια Μέτρα -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-hands me-2"></i>Επιτόπια Μέτρα
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="plates_removed" 
                                       id="plates_removed" {% if violation.plates_removed %}checked{% endif %}>
                                <label class="form-check-label" for="plates_removed">
                                    <i class="fas fa-square me-1"></i>Αφαίρεση Πινακίδων
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="license_removed" 
                                       id="license_removed" {% if violation.license_removed %}checked{% endif %}>
                                <label class="form-check-label" for="license_removed">
                                    <i class="fas fa-id-card me-1"></i>Αφαίρεση Άδειας Οδήγησης
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="registration_removed" 
                                       id="registration_removed" {% if violation.registration_removed %}checked{% endif %}>
                                <label class="form-check-label" for="registration_removed">
                                    <i class="fas fa-file-alt me-1"></i>Αφαίρεση Άδειας Κυκλοφορίας
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Φωτογραφία -->
            {% if violation.photo_filename %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-camera me-2"></i>Φωτογραφία Οχήματος
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <img src="{{ url_for('static', filename='uploads/' + violation.photo_filename) }}" 
                             alt="Φωτογραφία οχήματος" class="img-fluid rounded" style="max-height: 300px;">
                        <div class="mt-2">
                            <small class="text-muted">{{ violation.photo_filename }}</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Στοιχεία Οδηγού -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>Στοιχεία Οδηγού/Παραβάτη
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="driver_present" name="driver_present" 
                                       onchange="toggleDriverDetailsAdmin()" 
                                       {% if violation.driver_last_name %}checked{% endif %}>
                                <label class="form-check-label" for="driver_present">
                                    <i class="fas fa-user-check me-1"></i>
                                    Ο οδηγός/παραβάτης είναι παρών
                                </label>
                            </div>
                            <small class="text-muted">Επιλέξτε μόνο αν ο οδηγός βρίσκεται επιτόπου</small>
                        </div>
                    </div>
                    
                    <div id="driver-details-admin" {% if not violation.driver_last_name %}style="display: none;"{% endif %}>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="driver_last_name" class="form-label">
                                    <i class="fas fa-user me-1"></i>Επώνυμο *
                                </label>
                                <input type="text" class="form-control" id="driver_last_name" name="driver_last_name" 
                                       value="{{ violation.driver_last_name or '' }}">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="driver_first_name" class="form-label">
                                    <i class="fas fa-user me-1"></i>Όνομα *
                                </label>
                                <input type="text" class="form-control" id="driver_first_name" name="driver_first_name" 
                                       value="{{ violation.driver_first_name or '' }}">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="driver_father_name" class="form-label">
                                    <i class="fas fa-user me-1"></i>Όνομα Πατρός *
                                </label>
                                <input type="text" class="form-control" id="driver_father_name" name="driver_father_name" 
                                       value="{{ violation.driver_father_name or '' }}">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="driver_afm" class="form-label">
                                    <i class="fas fa-hashtag me-1"></i>ΑΦΜ *
                                </label>
                                <input type="text" class="form-control" id="driver_afm" name="driver_afm" 
                                       value="{{ violation.driver_afm or '' }}" maxlength="9">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Υπογραφή -->
            {% if violation.driver_signature %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-signature me-2"></i>Υπογραφή Οδηγού
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <img src="{{ violation.driver_signature }}" alt="Υπογραφή οδηγού" 
                             class="border rounded" style="max-width: 400px; height: 150px;">
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Μεταδεδομένα -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Μεταδεδομένα
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Καταχωρήθηκε από:</strong> {{ violation.officer.full_name }}</p>
                            <p><strong>Ημερομηνία καταχώρησης:</strong> {{ violation.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Τελευταία ενημέρωση:</strong> {{ violation.updated_at.strftime('%d/%m/%Y %H:%M') }}</p>
                            <p><strong>ID Παράβασης:</strong> #{{ violation.id }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Κουμπιά -->
            <div class="card">
                <div class="card-body text-center">
                    <button type="submit" class="btn btn-success btn-lg me-3">
                        <i class="fas fa-save me-2"></i>Αποθήκευση Αλλαγών
                    </button>
                    <a href="{{ url_for('admin_violations') }}" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-times me-2"></i>Ακύρωση
                    </a>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// Toggle driver details visibility in admin
function toggleDriverDetailsAdmin() {
    const checkbox = document.getElementById('driver_present');
    const driverDetails = document.getElementById('driver-details-admin');
    const driverInputs = driverDetails.querySelectorAll('input[type="text"]');
    
    if (checkbox.checked) {
        driverDetails.style.display = 'block';
        // Make driver fields required when visible
        driverInputs.forEach(input => {
            input.required = true;
        });
    } else {
        driverDetails.style.display = 'none';
        // Clear and make driver fields optional when hidden
        driverInputs.forEach(input => {
            input.required = false;
            input.value = '';
        });
    }
}

function editColor() {
    const select = document.getElementById('vehicle_color');
    const newColor = prompt('Εισάγετε νέο χρώμα οχήματος:');
    
    if (newColor && newColor.trim()) {
        const option = document.createElement('option');
        option.value = newColor.trim();
        option.textContent = newColor.trim();
        option.selected = true;
        select.appendChild(option);
    }
}

function editType() {
    const select = document.getElementById('vehicle_type');
    const newType = prompt('Εισάγετε νέο τύπο οχήματος:');
    
    if (newType && newType.trim()) {
        const option = document.createElement('option');
        option.value = newType.trim();
        option.textContent = newType.trim();
        option.selected = true;
        select.appendChild(option);
    }
}

// AFM validation
document.addEventListener('DOMContentLoaded', function() {
    const afmInput = document.getElementById('driver_afm');
    if (afmInput) {
        afmInput.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '');
        });
    }
});

// Confirm before leaving with unsaved changes
let formChanged = false;

document.querySelector('form').addEventListener('change', function() {
    formChanged = true;
});

window.addEventListener('beforeunload', function(e) {
    if (formChanged) {
        e.preventDefault();
        e.returnValue = '';
    }
});

document.querySelector('form').addEventListener('submit', function() {
    formChanged = false;
});
</script>
{% endblock %}
